# Query-2

<pre><code>
DECLARE @STARTDATE DATE = '2024-01-01';
DECLARE @ENDDATE DATE = '2024-12-31';

/**************** CHARGE ****************/
DROP TABLE IF EXISTS #TEMPCHARGE;

SELECT 
    'D1' AS DATA_SOURCE,
    YEAR(DOS) AS YEAR,
    MONTH(DOS) AS MONTH,
    SUM(CHARGE) AS CHARGE
INTO #TEMPCHARGE
FROM D1.DBO.CHARGE
WHERE DOS BETWEEN @STARTDATE AND @ENDDATE
GROUP BY YEAR(DOS), MONTH(DOS);

/**************** PAYMENT ****************/
DROP TABLE IF EXISTS #TEMPPAYMENT;

SELECT 
    'D1' AS DATA_SOURCE,
    YEAR(DOS) AS YEAR,
    MONTH(DOS) AS MONTH,
    SUM(PAYMENT) AS PAYMENT
INTO #TEMPPAYMENT
FROM D1.DBO.PAYMENT
WHERE DOS BETWEEN @STARTDATE AND @ENDDATE
GROUP BY YEAR(DOS), MONTH(DOS);

/**************** REFUND ****************/
DROP TABLE IF EXISTS #TEMPREFUND;

SELECT 
    'D1' AS DATA_SOURCE,
    YEAR(DOS) AS YEAR,
    MONTH(DOS) AS MONTH,
    SUM(REFUND) AS REFUND
INTO #TEMPREFUND
FROM D1.DBO.REFUND
WHERE DOS BETWEEN @STARTDATE AND @ENDDATE
GROUP BY YEAR(DOS), MONTH(DOS);

/**************** FINAL QUERY ****************/
SELECT 
    c.DATA_SOURCE,
    c.YEAR,
    c.MONTH,
    c.CHARGE,
    p.PAYMENT,
    r.REFUND
FROM #TEMPCHARGE c
LEFT JOIN #TEMPPAYMENT p 
    ON c.DATA_SOURCE = p.DATA_SOURCE AND c.YEAR = p.YEAR AND c.MONTH = p.MONTH
LEFT JOIN #TEMPREFUND r 
    ON c.DATA_SOURCE = r.DATA_SOURCE AND c.YEAR = r.YEAR AND c.MONTH = r.MONTH
ORDER BY c.YEAR, c.MONTH;
</code></pre>
